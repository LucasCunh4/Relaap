<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Liberação de Turma</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container mt-4">
        <header class="text-center mb-4">
            <h1>Painel de Liberação Diária</h1>
            <p class="lead">Defina a data/hora e selecione quem será liberado hoje.</p>
            <a href="admin.html">Ir para o Gerenciamento de Dados</a>
        </header>

        <main>
            <section class="card p-3 mb-4">
                <h5>1. Informações da Liberação</h5>
                <div class="row g-3">
                    <div class="col-md-5">
                        <label for="dataLiberacao" class="form-label"><strong>Data:</strong></label>
                        <input type="date" class="form-control" id="dataLiberacao">
                    </div>
                    <div class="col-md-3">
                        <label for="horarioLiberacao" class="form-label"><strong>Horário:</strong></label>
                        <input type="time" class="form-control" id="horarioLiberacao">
                    </div>
                    <div class="col-md-4">
                        <label for="select-responsavel" class="form-label"><strong>Responsável:</strong></label>
                        <select class="form-select" id="select-responsavel"></select>
                    </div>
                </div>
            </section>

            <section id="lista-liberacao">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0">2. Selecione as Pessoas para Liberar</h3>
                    <div>
                        <button class="btn btn-secondary btn-sm" id="btn-marcar-todos">Marcar Todos</button>
                        <button class="btn btn-secondary btn-sm" id="btn-desmarcar-todos">Desmarcar Todos</button>
                    </div>
                </div>
                <table class="table table-striped table-bordered mt-3">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 50px;" class="text-center">Liberar?</th>
                            <th>Nome Completo</th>
                            <th>Nome de Guerra</th>
                            <th style="width: 50px;" class="text-center">Negrito?</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-corpo"></tbody>
                </table>
            </section>

            <section class="text-center mt-4">
                <button class="btn btn-primary btn-lg" id="btn-visualizar">Visualizar e Imprimir Lista</button>
            </section>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            console.log("INDEX: Página principal carregada.");
            const tabelaCorpo = document.getElementById('tabela-corpo');
            const selectResponsavel = document.getElementById('select-responsavel');
            const btnVisualizar = document.getElementById('btn-visualizar');
            const btnMarcarTodos = document.getElementById('btn-marcar-todos');
            const btnDesmarcarTodos = document.getElementById('btn-desmarcar-todos');

            // MENSAGENS DE DIAGNÓSTICO IMPORTANTES
            console.log("INDEX: Lendo dados do localStorage...");
            const dadosDoStorage = localStorage.getItem('bancoDePessoas');
            console.log("INDEX: String lida do localStorage:", dadosDoStorage);

            const bancoDePessoas = JSON.parse(dadosDoStorage) || [];
            console.log("INDEX: Array de pessoas após o parse:", bancoDePessoas);

            const bancoDeResponsaveis = JSON.parse(localStorage.getItem('bancoDeResponsaveis')) || [];

            function carregarPagina() {
                tabelaCorpo.innerHTML = '';
                console.log("INDEX: Total de pessoas a serem renderizadas:", bancoDePessoas.length);
                bancoDePessoas.forEach((pessoa, index) => {
                    const linha = `
                    <tr>
                        <td class="text-center align-middle">
                            <input class="form-check-input checkbox-liberar" type="checkbox" value="${index}" checked>
                        </td>
                        <td class="align-middle">${pessoa.nomeCompleto}</td>
                        <td class="align-middle">${pessoa.nomeGuerra}</td>
                        <td class="text-center align-middle">
                            <input class="form-check-input checkbox-negrito" type="checkbox">
                        </td>
                    </tr>`;
                    tabelaCorpo.innerHTML += linha;
                });

                selectResponsavel.innerHTML = '';
                if (bancoDeResponsaveis.length === 0) {
                    selectResponsavel.innerHTML = '<option>Nenhum responsável cadastrado</option>';
                } else {
                    bancoDeResponsaveis.forEach((resp, index) => {
                        const option = `<option value="${index}">${resp.nome} - ${resp.posto}</option>`;
                        selectResponsavel.innerHTML += option;
                    });
                }
            }

            btnVisualizar.addEventListener('click', function () {
                const data = document.getElementById('dataLiberacao').value;
                const horario = document.getElementById('horarioLiberacao').value;
                const responsavelIndex = selectResponsavel.value;

                if (!data || !horario || responsavelIndex === '') {
                    alert("Por favor, preencha a data, horário e selecione um responsável.");
                    return;
                }

                const pessoasSelecionadas = [];
                const todasAsLinhas = tabelaCorpo.querySelectorAll('tr');
                
                todasAsLinhas.forEach((linha, index) => {
                    const checkboxLiberar = linha.querySelector('.checkbox-liberar');
                    if (checkboxLiberar && checkboxLiberar.checked) {
                        const checkboxNegrito = linha.querySelector('.checkbox-negrito');
                        const pessoa = bancoDePessoas[index];
                        pessoasSelecionadas.push({
                            nomeCompleto: pessoa.nomeCompleto,
                            nomeGuerra: pessoa.nomeGuerra,
                            emNegrito: checkboxNegrito ? checkboxNegrito.checked : false
                        });
                    }
                });

                if (pessoasSelecionadas.length === 0) {
                    alert("Nenhuma pessoa foi selecionada para a liberação.");
                    return;
                }

                const dadosDaLista = {
                    data: data,
                    horario: horario,
                    pessoas: pessoasSelecionadas,
                    assinatura: bancoDeResponsaveis[responsavelIndex]
                };

                localStorage.setItem('dadosDaLista', JSON.stringify(dadosDaLista));
                window.open('lista.html', '_blank');
            });

            function setarTodosCheckboxes(marcado) {
                const checkboxes = tabelaCorpo.querySelectorAll('.checkbox-liberar');
                checkboxes.forEach(cb => cb.checked = marcado);
            }
            btnMarcarTodos.addEventListener('click', () => setarTodosCheckboxes(true));
            btnDesmarcarTodos.addEventListener('click', () => setarTodosCheckboxes(false));

            carregarPagina();
        });
    </script>
</body>
</html>
